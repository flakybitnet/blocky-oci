stages:
  - build
  - mirror

variables:
  APP_NAME: 'blocky'
  IMAGE_NAME: 'server'
  BLOCKY_VERSION: '0.28.2'

distributives:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - when: on_success
  image: public.ecr.aws/docker/library/debian:trixie-slim
  variables:
    GIT_STRATEGY: none
  script:
    - echo 'Updating and installing required system packages and dependencies'
    - apt -qq update && apt install -qq -y wget
    - mkdir dist/

    - echo "Downloading Blocky $BLOCKY_VERSION"
    - wget -nv "https://github.com/0xERR0R/blocky/releases/download/v${BLOCKY_VERSION}/blocky_v${BLOCKY_VERSION}_Linux_x86_64.tar.gz"
    - wget -nv "https://github.com/0xERR0R/blocky/releases/download/v${BLOCKY_VERSION}/blocky_checksums.txt"
    - sha256sum -c --ignore-missing blocky_checksums.txt
    - tar -xpzf "blocky_v${BLOCKY_VERSION}_Linux_x86_64.tar.gz" -C dist/
  artifacts:
    paths:
      - dist/

images:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - when: on_success
  needs:
    - distributives
  dependencies:
    - distributives
  image: quay.io/buildah/stable:v1.41.5
  variables:
    STORAGE_DRIVER: 'vfs'
  script:
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - buildah build -t "$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME" ./server.containerfile
    - buildah push "$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME"

images-debug:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - when: on_success
  needs:
    - distributives
  dependencies:
    - distributives
  image: quay.io/buildah/stable:v1.41.5
  variables:
    STORAGE_DRIVER: 'vfs'
  script:
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - buildah build -t "$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME-debug" ./server-debug.containerfile
    - buildah push "$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME-debug"

mirror-git-github:
  stage: mirror
  rules:
    - if: $CI_PIPELINE_SOURCE == 'push'
  dependencies: []
  image: docker.io/alpine/git:v2.49.1
  variables:
    GIT_STRATEGY: clone
  script:
    - git remote add github "https://$GITHUB_USER:$GITHUB_PASSWORD@github.com/flakybitnet/blocky-oci.git"
    - if [ -n "${CI_COMMIT_BRANCH-}" ]; then
        git checkout -b "$CI_COMMIT_BRANCH";
        git fetch github;
        git push --force-with-lease github "$CI_COMMIT_BRANCH";
        fi
    - if [ -n "${CI_COMMIT_TAG-}" ]; then
        git push github tag $CI_COMMIT_TAG;
        fi

mirror-images-github:
  stage: mirror
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []
  image: public.ecr.aws/flakybitnet/skopeo:1.20.0-fb1
  variables:
    REGISTRY: ghcr.io
    IMAGE: flakybitnet/blocky-$IMAGE_NAME
    GIT_STRATEGY: none
  script:
    - echo "$GITHUB_PASSWORD" | skopeo login -u "$GITHUB_USER" --password-stdin "$REGISTRY"
    - skopeo copy "docker://$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME" "docker://$REGISTRY/$IMAGE:$CI_COMMIT_REF_NAME"
    - skopeo copy "docker://$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME-debug" "docker://$REGISTRY/$IMAGE:$CI_COMMIT_REF_NAME-debug"

mirror-images-quay:
  stage: mirror
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []
  image: public.ecr.aws/flakybitnet/skopeo:1.20.0-fb1
  variables:
    REGISTRY: quay.io
    IMAGE: flakybitnet/blocky-$IMAGE_NAME
    GIT_STRATEGY: none
  script:
    - echo "$QUAY_PASSWORD" | skopeo login -u "$QUAY_USER" --password-stdin "$REGISTRY"
    - skopeo copy "docker://$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME" "docker://$REGISTRY/$IMAGE:$CI_COMMIT_REF_NAME"
    - skopeo copy "docker://$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME-debug" "docker://$REGISTRY/$IMAGE:$CI_COMMIT_REF_NAME-debug"

mirror-images-amazon:
  stage: mirror
  rules:
    - if: $CI_COMMIT_TAG
  dependencies: []
  image: public.ecr.aws/flakybitnet/skopeo:1.20.0-fb1
  variables:
    REGISTRY: public.ecr.aws
    IMAGE: flakybitnet/blocky/$IMAGE_NAME
    GIT_STRATEGY: none
    AWS_ACCESS_KEY_ID: $ECR_USER
    AWS_SECRET_ACCESS_KEY: $ECR_PASSWORD
  script:
    - printf '{"credHelpers":{"%s":"%s"}}' "$REGISTRY" 'ecr-login' > "$HOME/auth.json"
    - skopeo copy "docker://$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME" "docker://$REGISTRY/$IMAGE:$CI_COMMIT_REF_NAME"
        --dest-authfile="$HOME/auth.json"
    - skopeo copy "docker://$CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_REF_NAME-debug" "docker://$REGISTRY/$IMAGE:$CI_COMMIT_REF_NAME-debug"
        --dest-authfile="$HOME/auth.json"
